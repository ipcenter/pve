#!/bin/bash
# =========================================================
# Proxmox VE Web UI TLS ä¸€é”®ä¿®å¤è„šæœ¬
# é€‚ç”¨åœºæ™¯ï¼špveproxy æ­£å¸¸ï¼Œä½† HTTPS 8006 TLS æ¡æ‰‹å¤±è´¥
# ä½œè€…æ€è·¯ï¼šåŸºäºçœŸå®æ•…éšœä¿®å¤æµç¨‹æŠ½è±¡
# =========================================================

set -euo pipefail

LOG="/root/pve_webui_tls_repair.log"
exec > >(tee -a "$LOG") 2>&1

echo "=================================================="
echo " PVE Web UI TLS è‡ªæ„ˆä¿®å¤è„šæœ¬"
echo " ä¸»æœº: $(hostname)"
echo " æ—¶é—´: $(date)"
echo "=================================================="

### 1. åŸºç¡€å®‰å…¨æ£€æŸ¥ ######################################

echo -e "\n[1/6] åŸºç¡€ç¯å¢ƒæ£€æŸ¥"

for svc in pveproxy pvedaemon pvestatd pve-cluster; do
    if ! systemctl is-active --quiet "$svc"; then
        echo "âŒ æœåŠ¡ $svc æœªè¿è¡Œï¼Œæ‹’ç»æ‰§è¡Œä¿®å¤"
        exit 1
    fi
done
echo "âœ… æ ¸å¿ƒæœåŠ¡è¿è¡Œæ­£å¸¸"

if ! mountpoint -q /etc/pve; then
    echo "âŒ /etc/pve æœªæŒ‚è½½ï¼ˆpmxcfs å¼‚å¸¸ï¼‰ï¼Œæ‹’ç»æ‰§è¡Œ"
    exit 1
fi
echo "âœ… /etc/pve æŒ‚è½½æ­£å¸¸"

### 2. TLS æ¡æ‰‹æ£€æµ‹ ######################################

echo -e "\n[2/6] TLS æ¡æ‰‹å¥åº·æ£€æµ‹"

if openssl s_client -connect 127.0.0.1:8006 -servername "$(hostname)" \
    </dev/null 2>/dev/null | grep -q "BEGIN CERTIFICATE"; then
    echo "âœ… TLS æ¡æ‰‹æ­£å¸¸ï¼Œå½“å‰æ— éœ€ä¿®å¤"
    exit 0
fi

echo "âš ï¸ TLS æ¡æ‰‹å¤±è´¥ï¼Œè¿›å…¥ä¿®å¤æµç¨‹"

### 3. ä¸»æœºåä¸€è‡´æ€§æ ¡éªŒ ##################################

echo -e "\n[3/6] ä¸»æœºåä¸€è‡´æ€§æ ¡éªŒ"

HN1="$(hostname)"
HN2="$(cat /etc/hostname)"
NODE_DIR="/etc/pve/nodes/$HN1"

if [[ "$HN1" != "$HN2" ]]; then
    echo "âŒ hostname ä¸ /etc/hostname ä¸ä¸€è‡´"
    echo " hostname: $HN1"
    echo " /etc/hostname: $HN2"
    exit 1
fi

if [[ ! -d "$NODE_DIR" ]]; then
    echo "âŒ /etc/pve/nodes/$HN1 ä¸å­˜åœ¨"
    exit 1
fi

grep -q "$HN1" /etc/hosts || {
    echo "âŒ /etc/hosts æœªåŒ…å«ä¸»æœºå $HN1"
    exit 1
}

echo "âœ… ä¸»æœºåä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"

### 4. å¤‡ä»½å¹¶æ¸…ç†æ—§è¯ä¹¦ ###############################

echo -e "\n[4/6] å¤‡ä»½å¹¶æ¸…ç†æ—§ TLS è¯ä¹¦"

BACKUP_DIR="/root/pve-ssl-backup-$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

if ls /etc/pve/local/pve-ssl.* &>/dev/null; then
    mv /etc/pve/local/pve-ssl.* "$BACKUP_DIR/"
    echo "âœ… æ—§è¯ä¹¦å·²å¤‡ä»½è‡³ $BACKUP_DIR"
else
    echo "âš ï¸ æœªå‘ç°æ—§è¯ä¹¦æ–‡ä»¶"
fi

### 5. å¼ºåˆ¶é‡å»ºè¯ä¹¦ #####################################

echo -e "\n[5/6] å¼ºåˆ¶é‡å»º PVE TLS è¯ä¹¦"

systemctl stop pveproxy
pvecm updatecerts --force
systemctl start pveproxy

sleep 2

### 6. ä¿®å¤ç»“æœéªŒè¯ #####################################

echo -e "\n[6/6] ä¿®å¤ç»“æœéªŒè¯"

if openssl s_client -connect 127.0.0.1:8006 -servername "$HN1" \
    </dev/null 2>/dev/null | grep -q "BEGIN CERTIFICATE"; then
    echo "âœ… TLS ä¿®å¤æˆåŠŸï¼ŒWeb UI å·²æ¢å¤"
    echo "ğŸ‘‰ https://$HN1:8006"
else
    echo "âŒ ä¿®å¤å¤±è´¥ï¼Œè¯·äººå·¥ä»‹å…¥"
    echo "æ—¥å¿—æ–‡ä»¶ï¼š$LOG"
    exit 2
fi

echo "=================================================="
echo " ä¿®å¤æµç¨‹å®Œæˆ"
echo "=================================================="
